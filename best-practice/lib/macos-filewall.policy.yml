# Fleet's Fleet Enterprise Edition (EE) license applies to the code in this file. Read about the license here: https://github.com/fleetdm/fleet/blob/main/ee/LICENSE

policy:
  name: macOS - CIS - Ensure Firewall logging is enabled and configured (MDM required)
  platform: darwin
  description: |
    The socketfilter Firewall is what is used when the Firewall is turned on in the Security & Privacy Preference Pane. In order to appropriately monitor what access is allowed and denied, logging must be enabled. The logging level must be set to "detailed" to be useful in monitoring connection attempts that the firewall detects. Throttled login is not sufficient for examine Firewall connection attempts.
  resolution: |
    Profile Method:
    Create or edit a configuration profile with the following information:
    1. The Payload Type string is com.apple.security.firewall 
    2. The key to include is EnableFirewall
    3. The key must be set to<true/>
    4. The key to also include is EnableLogging
    5. The key must be set to<true/>
    6. The key to also include is LoggingOption
    7. The key must be set to <string>detail</string>
  query: |
    SELECT 1 WHERE
    (
      EXISTS (
        SELECT 1 FROM managed_policies WHERE 
            domain='com.apple.security.firewall' AND 
            name='EnableLogging' AND 
            (value = 1 OR value = 'true') AND 
            username = ''
        )
      AND EXISTS (
        SELECT 1 FROM managed_policies WHERE 
            domain='com.apple.security.firewall' AND 
            name='LoggingOption' AND 
            value = "detail" AND 
            username = ''
        )
      AND NOT EXISTS (
        SELECT 1 FROM managed_policies WHERE 
            domain='com.apple.security.firewall' AND 
            name='EnableLogging' AND 
            (value != 1 AND value != 'true')
        )
      AND NOT EXISTS (
        SELECT 1 FROM managed_policies WHERE 
            domain='com.apple.security.firewall' AND 
            name='LoggingOption' AND 
            value != "detail"
        )
    )
    OR
    (
      EXISTS ( 
        SELECT 1 FROM plist WHERE 
            path='/Library/Preferences/com.apple.alf.plist' AND 
            key='loggingenabled' AND 
            value = 1 
        )
      AND EXISTS ( 
        SELECT 1 FROM plist WHERE 
        path='/Library/Preferences/com.apple.alf.plist' AND 
        key='loggingoption' AND 
        value = 2 
        )
    );